<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
<head>
  <title>send_request (EventMachine::Protocols::HttpClient)</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <link rel="stylesheet" href="../../../.././rdoc-style.css" type="text/css" media="screen" />
</head>
<body class="standalone-code">
  <pre><span class="ruby-comment cmt"># File lib/em/protocols/httpclient.rb, line 105</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">send_request</span> <span class="ruby-identifier">args</span>
        <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:verb</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:method</span>] <span class="ruby-comment cmt"># Support :method as an alternative to :verb.</span>
        <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:verb</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">:get</span> <span class="ruby-comment cmt"># IS THIS A GOOD IDEA, to default to GET if nothing was specified?</span>

        <span class="ruby-identifier">verb</span> = <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:verb</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">upcase</span>
        <span class="ruby-keyword kw">unless</span> [<span class="ruby-value str">&quot;GET&quot;</span>, <span class="ruby-value str">&quot;POST&quot;</span>, <span class="ruby-value str">&quot;PUT&quot;</span>, <span class="ruby-value str">&quot;DELETE&quot;</span>, <span class="ruby-value str">&quot;HEAD&quot;</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">verb</span>)
          <span class="ruby-identifier">set_deferred_status</span> <span class="ruby-identifier">:failed</span>, {<span class="ruby-identifier">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>} <span class="ruby-comment cmt"># TODO, not signalling the error type</span>
          <span class="ruby-keyword kw">return</span> <span class="ruby-comment cmt"># NOTE THE EARLY RETURN, we're not sending any data.</span>
        <span class="ruby-keyword kw">end</span>

        <span class="ruby-identifier">request</span> = <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:request</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">&quot;/&quot;</span>
        <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">request</span>[<span class="ruby-value">0</span>,<span class="ruby-value">1</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;/&quot;</span>
          <span class="ruby-identifier">request</span> = <span class="ruby-value str">&quot;/&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">request</span>
        <span class="ruby-keyword kw">end</span>

        <span class="ruby-identifier">qs</span> = <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:query_string</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">&quot;&quot;</span>
        <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">qs</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">qs</span>[<span class="ruby-value">0</span>,<span class="ruby-value">1</span>] <span class="ruby-operator">!=</span> <span class="ruby-value str">'?'</span>
          <span class="ruby-identifier">qs</span> = <span class="ruby-value str">&quot;?&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">qs</span>
        <span class="ruby-keyword kw">end</span>

        <span class="ruby-identifier">version</span> = <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:version</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">&quot;1.1&quot;</span>

        <span class="ruby-comment cmt"># Allow an override for the host header if it's not the connect-string.</span>
        <span class="ruby-identifier">host</span> = <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:host_header</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:host</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">&quot;_&quot;</span>
        <span class="ruby-comment cmt"># For now, ALWAYS tuck in the port string, although we may want to omit it if it's the default.</span>
        <span class="ruby-identifier">port</span> = <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:port</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">!=</span> <span class="ruby-value">80</span> <span class="ruby-operator">?</span> <span class="ruby-node">&quot;:#{args[:port]}&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;&quot;</span>

        <span class="ruby-comment cmt"># POST items.</span>
        <span class="ruby-identifier">postcontenttype</span> = <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:contenttype</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">&quot;application/octet-stream&quot;</span>
        <span class="ruby-identifier">postcontent</span> = <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:content</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">&quot;&quot;</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;oversized content in HTTP POST&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">postcontent</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">MaxPostContentLength</span>

        <span class="ruby-comment cmt"># ESSENTIAL for the request's line-endings to be CRLF, not LF. Some servers misbehave otherwise.</span>
        <span class="ruby-comment cmt"># TODO: We ASSUME the caller wants to send a 1.1 request. May not be a good assumption.</span>
        <span class="ruby-identifier">req</span> = [
          <span class="ruby-node">&quot;#{verb} #{request}#{qs} HTTP/#{version}&quot;</span>,
          <span class="ruby-node">&quot;Host: #{host}#{port}&quot;</span>,
          <span class="ruby-value str">&quot;User-agent: Ruby EventMachine&quot;</span>,
        ]

          <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">verb</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;POST&quot;</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">verb</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;PUT&quot;</span>
            <span class="ruby-identifier">req</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;Content-type: #{postcontenttype}&quot;</span>
            <span class="ruby-identifier">req</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;Content-length: #{postcontent.length}&quot;</span>
          <span class="ruby-keyword kw">end</span>

          <span class="ruby-comment cmt"># TODO, this cookie handler assumes it's getting a single, semicolon-delimited string.</span>
          <span class="ruby-comment cmt"># Eventually we will want to deal intelligently with arrays and hashes.</span>
          <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:cookie</span>]
            <span class="ruby-identifier">req</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;Cookie: #{args[:cookie]}&quot;</span>
          <span class="ruby-keyword kw">end</span>

          <span class="ruby-comment cmt"># Allow custom HTTP headers, e.g. SOAPAction</span>
          <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:custom_headers</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">req</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{k}: #{v}&quot;</span>
          <span class="ruby-keyword kw">end</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:custom_headers</span>]

          <span class="ruby-comment cmt"># Basic-auth stanza contributed by Matt Murphy.</span>
          <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:basic_auth</span>]
            <span class="ruby-identifier">basic_auth_string</span> = [<span class="ruby-node">&quot;#{args[:basic_auth][:username]}:#{args[:basic_auth][:password]}&quot;</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-value str">'m'</span>).<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/\n/</span>,<span class="ruby-value str">''</span>)
            <span class="ruby-identifier">req</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;Authorization: Basic #{basic_auth_string}&quot;</span>
          <span class="ruby-keyword kw">end</span>

          <span class="ruby-identifier">req</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&quot;</span>
          <span class="ruby-identifier">reqstring</span> = <span class="ruby-identifier">req</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">l</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;#{l}\r\n&quot;</span>}.<span class="ruby-identifier">join</span>
          <span class="ruby-identifier">send_data</span> <span class="ruby-identifier">reqstring</span>

          <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">verb</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;POST&quot;</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">verb</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;PUT&quot;</span>
            <span class="ruby-identifier">send_data</span> <span class="ruby-identifier">postcontent</span>
          <span class="ruby-keyword kw">end</span>
      <span class="ruby-keyword kw">end</span></pre>
</body>
</html>